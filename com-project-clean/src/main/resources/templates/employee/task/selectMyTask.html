<!DOCTYPE html>
<html xmlns:th="http://www.thymleaf.org"
	  xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<meta charset="UTF-8">
    <link rel="stylesheet"
    	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" >
   	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<title>ProjectClean</title>
</head>
<body>

	<table align="center" border="1">
		<tr>
			<th>예약 번호</th>
			<th>고객 이름</th>
			<th>시작 시간</th>
			<th>종료 시간</th>
			<th>예상 급여</th>
		</tr>
		<tr th:each="resList : ${ reservationList }">
			<td th:text="${ resList.reservationNo }"></td>
			<td th:text="${ resList.userName }"></td>
			<td th:text="${ resList.businessStartTime }"></td>
			<td th:text="${ resList.businessEndTime }"></td>
			<td th:text="${ resList.totalPayment }"></td>
		</tr>
	</table>
	<div th:include="common/header.html"></div>
	<div th:include="common/taskAside.html"></div>

	<script>
		const resultMessage = "[[${resultMessage}]]";
		if(resultMessage){
			alert(resultMessage)
		}
	</script>	
	
	<table id="taskInfo" border="1">
		<thead>
			<tr>
				<td width="100">예약 번호</td>
				<td width="100">고객 이름</td>
				<td width="200">시작 시간</td>
				<td width="200">종료 시간</td>
				<td width="100">예상 급여</td>
				<td width="100">업무 시작</td>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	 
	 
	<script>
		var nowtime = new Date();
		window.onload = function(){
			$.ajax({
				url : "selectMyTask",
				method : "post",
				success:function(data){
					
					const $table = $("#taskInfo tbody");
					$table.html("");
					for(var index in data){
						$tr = $("<tr>");
						$noTd = $("<td1>").addClass('rn').text(data[index].reservationNo);
						$nameTd = $("<td>").text(data[index].userName);
						$startTimeTd = $("<td>").addClass('st').text(data[index].businessStartTime);
						$endTimeTd = $("<td>").text(data[index].businessEndTime);
						$paymentTd = $("<td>").text(data[index].totalPayment)
						$buttonTd = $("<button></button>").addClass('btn').addClass([index]).append("테스트");
						
						$tr.append($noTd);
						$tr.append($nameTd);
						$tr.append($startTimeTd);
						$tr.append($endTimeTd);
						$tr.append($paymentTd);
 						$tr.append($buttonTd); 
						$table.append($tr);
						var startTime = new Date();
						startTime = data[index].businessStartTime;
						console.log("업무 시작 시간 : " + startTime)
						console.log(typeof(startTime))
					};
				},
				error:function(error){
					console.log(error);
				}
			});
			
			setTimeout(function() {
				const buttons = document.querySelectorAll('table#taskInfo tbody tr button');
				
				for(let i = 0; i < buttons.length; i++) {
					
					nowtime.setMinutes(nowtime.getMinutes() - 30)
					const nowtime2 = nowtime.toString().substring(15, 21);
					
					const button = buttons[i];
					button.onclick = function() {
						const timer = button.parentNode.querySelector('.st').innerText.substring(10, 16);
						
						if(timer < nowtime2){
							
								const resNo1 = document.querySelectorAll('table#taskInfo tbody tr td1');
								const resNo2 = resNo1[i];
								var resNo3 = resNo2.parentNode.querySelector('.rn').innerText;
							 	location.href="/employee/checkList/start?re="+ resNo3;
							
						} else{
							alert("업무를 시작할 수 없습니다. ")
						}; 
					}						

				}
				
			}, 100)
			
	};
   	</script>
   	
</body>
</html>